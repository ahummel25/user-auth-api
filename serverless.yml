service: user-auth-api

# You can pin your service to only deploy with a specific Serverless version
# Check out our docs for more details
frameworkVersion: '>=2.8.0'

custom:
  commonPrefix: ${self:service.name}-${self:provider.stage}-api
  vpc: ${file(./${self:provider.stage}.yml):vpc}

provider:
  name: aws
  runtime: provided.al2
  tracing:
    apiGateway: true
    lambda: true
  apiGateway:
    shouldStartNameWithService: true  
  logs:
    restApi:
      accessLogging: true
      executionLogging: true
      role: 'arn:aws:iam::#{AWS::AccountId}:role/${self:custom.commonPrefix}GatewayRole'
      roleManagedExternally: true
  iamRoleStatements:
    - Effect: 'Allow'
      Action:
        - lambda:AddPermission
        - lambda:InvokeFunction
        - lambda:RemovePermission
        - xray:PutTraceSegments
        - xray:PutTelemetryRecords
      Resource:
        - Fn::Join:
            - ':'
            - - arn:aws:lambda
              - Ref: AWS::Region
              - Ref: AWS::AccountId
              - function:${self:service}-${opt:stage, self:provider.stage}-*
  stage: ${opt:stage, 'dev'}
  timeout: 10

package:
  exclude:
    - ./**
  individually: true

functions:
  auth: ${file(lambda/auth/function.yml)}